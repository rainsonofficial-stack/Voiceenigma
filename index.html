<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>OS | AOD Discreet Magic</title>
    
    <!-- PWA MANIFEST LINK -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- LOCAL DICTIONARY SOURCE -->
    <script src="./large_dictionary.js"></script>

    <style>
        /* AOD Styling (Dark, Minimal, Discreet) */
        html, body {
            margin: 0;
            padding: 0;
            font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; 
            height: 100%;
            background: #000;
        }

        #app {
            width: 100%;
            height: 100%;
            max-width: 600px;
            max-height: 100vh;
            position: relative;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            color: #c4c4c4; 
            box-sizing: border-box;
            padding: 30px 0; 
        }
        
        /* Clock Widget */
        .time-display {
            font-size: 80px;
            font-weight: 300;
            margin-bottom: 5px;
            color: white; 
            cursor: pointer; 
        }
        .date-display {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 25px;
            color: #c4c4c4; 
        }

        /* --- Notification Bar (Discreet Shopping List / Final Word) --- */
        #system-notification {
            width: 90%;
            max-width: 300px; 
            padding: 8px 12px; 
            background: #282a2d; 
            border-radius: 8px; 
            display: flex;
            align-items: center;
            transition: opacity 0.5s;
            margin-top: 10px; 
        }
        .notif-icon-svg {
            margin-right: 8px;
            color: #c4c4c4; 
            width: 16px;
            height: 16px;
            line-height: 1;
            flex-shrink: 0;
        }
        .notif-text {
            font-size: 13px;
            color: #d1d1d1;
            font-weight: 500;
            word-break: break-word; 
        }
        .final-word-placeholder {
            color: #ffffff; 
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        /* --- Bottom Icons Container --- */
        #bottom-icons {
            position: absolute;
            bottom: 30px;
            width: 90%;
            max-width: 380px; 
            display: flex;
            justify-content: space-between;
            align-items: flex-end; 
            box-sizing: border-box;
            padding: 0 10px;
            margin-top: auto; 
        }
        
        /* --- Spotify Widget --- */
        #music-player {
            flex-grow: 1;
            max-width: 250px; 
            min-width: 150px;
            padding: 8px; 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(5px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            margin: 0 10px; 
            box-sizing: border-box;
        }

        .album-art {
            width: 30px; 
            height: 30px;
            background: #4f5358;
            border-radius: 6px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .album-art svg {
            width: 16px;
            height: 16px;
        }
        .song-info {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
        }
        .song-title {
            color: white;
            font-weight: 600;
            font-size: 13px; 
            margin-bottom: 2px;
        }
        .song-artist {
            font-size: 11px; 
            color: #c4c4c4;
        }
        .timeline {
            margin-left: 10px;
            font-size: 12px;
            flex-shrink: 0;
        }
        #current-second {
            color: white;
            font-weight: 600;
        }
        
        .bottom-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c4c4c4;
            cursor: pointer;
            flex-shrink: 0;
        }

    </style>
</head>
<body>
    <div id="app">
        <!-- Clock Widget (Double tap here to trigger voice input) -->
        <div class="time-display" id="aod-time"></div>
        <div class="date-display" id="aod-date"></div>

        <!-- System Notification (Used for Word List / Final Word Reveal) -->
        <div id="system-notification">
            <div class="notif-icon-svg" id="notif-icon">
                <!-- Initial Gear SVG -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-8M20 12h-8M4 12h8M12 4v8M18.36 5.64l-4.24 4.24M5.64 18.36l4.24-4.24M18.36 18.36l-4.24-4.24M5.64 5.64l4.24 4.24"></path></svg>
            </div>
            <div class="notif-text" id="notif-text">System Update Available</div>
        </div>

        <!-- Bottom Icons and Music Player -->
        <div id="bottom-icons">
            <div class="bottom-icon" title="Phone">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            </div>
            
            <!-- Music Player Widget -->
            <div id="music-player">
                <div class="album-art">
                    <!-- Music Note SVG Icon -->
                    <svg viewBox="0 0 24 24" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                </div>
                <div class="song-info">
                    <div class="song-title">Shape of You</div>
                    <div class="song-artist">Ed Sheeran</div>
                </div>
                <div class="timeline">
                    0:<span id="current-second">00</span>
                </div>
            </div>

            <div class="bottom-icon" title="Camera">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
        </div>
    </div>
    
    <script>
        // Global variable LARGE_DICTIONARY is now defined by the local large_dictionary.js file.
        
        const APP = {
            // Configuration
            PASSCODE_LENGTH: 4,
            DOUBLE_TAP_THRESHOLD: 300, 
            LAST_TAP_TIME: 0,
            
            // State Variables
            APP_STATE: 'AOD_LOCK', 
            isListening: false,     
            MATCHES: [], 
            HISTORY: [], 
            CURRENT_POSITION_INDEX: 0, 
            recognizer: null,

            // D4 Shape Definitions
            LETTER_SHAPES: {
                1: new Set('AEFHIKLMNTVWXYZ'.split('')), 
                2: new Set('BDGJPRU'.split('')), 
                3: new Set('COS'.split('')), 
            },

            // D4 Trigger Words
            D4_TRIGGERS: {
                'WORD': 1, 'WORDS': 1,
                'DIFFERENT': 2,
                'OPTION': 3, 'OPTIONS': 3,
            },

            // Spelled-out numbers mapping
            NUMBER_WORDS: {
                'ONE': 1, 'TWO': 2, 'THREE': 3, 'FOUR': 4, 
                'FIVE': 5, 'SIX': 6, 'SEVEN': 7, 'EIGHT': 8, 'NINE': 9
            },

            // SVG Icons
            ICON_GEAR_SVG: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-8M20 12h-8M4 12h8M12 4v8M18.36 5.64l-4.24 4.24M5.64 18.36l4.24-4.24M18.36 18.36l-4.24-4.24M5.64 5.64l4.24 4.24"></path></svg>`,
            ICON_CHAT_SVG: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,

            // --- UI/Helper Functions ---
            
            logStatus(message, isError = false) {
                if (isError) {
                    console.error(`[MagicApp ERROR] ${message}`);
                } else {
                    console.log(`[MagicApp] ${message}`);
                }
            },
            
            updateTime() {
                const now = new Date();
                
                // Get hours (0-23) and minutes
                let hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                
                // Convert 24h to 12h format (1-12) without AM/PM
                hours = hours % 12;
                hours = hours ? hours : 12; // The hour '0' (midnight) becomes '12'
                
                const time = `${hours}:${minutes}`; 
                const date = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                document.getElementById('aod-time').textContent = time;
                document.getElementById('aod-date').textContent = date;
            },

            isVowel(char) {
                const upper = char.toUpperCase();
                return ['A', 'E', 'I', 'O', 'U'].includes(upper);
            },

            getVowelIndices(word) {
                const indices = [];
                for (let i = 0; i < word.length; i++) {
                    if (word[i].toUpperCase().match(/[AEIOU]/)) {
                        indices.push(i + 1); // 1-based position
                    }
                }
                return indices;
            },

            // --- Voice Recognition Control (Continuous Listening) ---
            startListening() {
                this.isListening = true;
                this.APP_STATE = 'AOD_LISTENING';
                try {
                    this.recognizer.stop(); 
                    this.recognizer.start();
                    this.logStatus("Started continuous listening session.");
                } catch (e) {
                    this.logStatus(`Error starting recognition: ${e.message}`, true);
                }
            },
            
            stopListening() {
                this.isListening = false;
                this.APP_STATE = 'AOD_DISPLAY_FINAL';
                try {
                    this.recognizer.stop();
                    this.logStatus("Stopped continuous listening.");
                } catch (e) {}
            },

            initVoiceRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    this.logStatus("Speech Recognition not supported.", true);
                    return;
                }
                
                this.recognizer = new SpeechRecognition();
                this.recognizer.continuous = false; 
                this.recognizer.interimResults = false;
                this.recognizer.lang = 'en-US'; 
                
                this.recognizer.onstart = () => { this.logStatus("Recognizing..."); };

                // Auto-restart logic
                this.recognizer.onend = () => {
                    if (this.isListening) {
                        setTimeout(() => {
                            if (this.isListening) {
                                this.logStatus("Auto-restarting listening...");
                                try {
                                    this.recognizer.start();
                                } catch (e) {
                                    this.logStatus(`Restart error: ${e.message}`, true);
                                }
                            }
                        }, 100); 
                    } else {
                        this.logStatus("Listening ended normally.");
                    }
                };

                this.recognizer.onerror = (event) => {
                    if (event.error !== 'no-speech' && this.isListening) {
                         this.logStatus(`Voice Error (${event.error}). Attempting restart.`, true);
                    }
                };
                
                this.recognizer.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toUpperCase().trim();
                    this.logStatus(`Transcript received: "${transcript}"`);
                    
                    if (this.MATCHES.length === 0) {
                        this.handleInitialPasscode(transcript);
                    } else {
                        this.handleLetterInput(transcript);
                    }
                };
            },
            
            // --- Double Tap Handler ---
            handleDoubleTap(event) {
                const target = event.target.closest('#aod-time'); 
                if (!target) return;

                const currentTime = new Date().getTime();
                const timeSinceLastTap = currentTime - this.LAST_TAP_TIME;
                this.LAST_TAP_TIME = currentTime;

                if (timeSinceLastTap < this.DOUBLE_TAP_THRESHOLD) {
                    event.preventDefault(); 
                    
                    if (this.APP_STATE === 'AOD_LOCK' || !this.isListening) {
                        if (this.recognizer) {
                            this.startListening();
                            this.LAST_TAP_TIME = 0; 
                        }
                    } else if (this.APP_STATE === 'AOD_DISPLAY_FINAL') {
                        this.resetApp();
                    }
                }
            },

            // --- Core Logic (Unchanged filter functions) ---
            filterDictionary(d1, d2, d3, d4, initialList) {
                if (typeof initialList === 'undefined' || initialList.length === 0) { return []; }
                const dictionary = initialList.map(w => w.toUpperCase());
                
                return dictionary.filter(word => {
                    const length = word.length;
                    const vIndices = this.getVowelIndices(word);
                    const vowelCount = vIndices.length;
                    const firstLetter = word[0];

                    if (length !== d1) return false;
                    if (d2 > 0 && (vowelCount < 1 || vIndices[0] !== d2)) return false;
                    if (d3 > 0 && (vowelCount < 2 || vIndices[1] !== d3)) return false;
                    if (d4 > 0) {
                        const shapeSet = this.LETTER_SHAPES[d4];
                        if (!shapeSet || !shapeSet.has(firstLetter)) return false;
                    }
                    return true;
                });
            },
            
            getDisambiguationIndex(matches) {
                if (matches.length <= 1) return -1;
                const minLength = Math.min(...matches.map(w => w.length));
                let bestIndex = -1;
                let maxUniqueLetters = 1; 
                
                for (let i = 0; i < minLength; i++) {   
                    const lettersAtPosition = matches
                        .map(word => word.length > i ? word[i] : null)
                        .filter(l => l !== null);
                    if (lettersAtPosition.length === 0) continue;
                    const uniqueLetters = new Set(lettersAtPosition);

                    if (uniqueLetters.size > maxUniqueLetters &&   
                        (lettersAtPosition.length / matches.length > 0.5)) {
                        maxUniqueLetters = uniqueLetters.size;
                        bestIndex = i + 1; 
                    }
                }
                return bestIndex;
            },

            // --- Handlers ---
            
            handleInitialPasscode(transcript) {
                let d4 = 0;
                let numbers = [];
                const words = transcript.split(' ').map(w => w.trim());

                // Logic to extract D1, D2, D3, and D4 from the end of the phrase
                for (let i = words.length - 1; i >= 0; i--) {
                    const word = words[i];
                    const triggerValue = this.D4_TRIGGERS[word];
                    if (triggerValue) {
                        d4 = triggerValue;
                        
                        // Parse numbers from the beginning of the phrase
                        numbers = words.slice(0, i)
                            .map(w => {
                                // Check for digit (e.g., '7')
                                if (!isNaN(parseInt(w, 10)) && w.length === 1) return Number(w); 
                                // Check for spelled-out word (e.g., 'SEVEN')
                                const spelled = this.NUMBER_WORDS[w];
                                if (spelled) return spelled; 
                                return null; // Ignore other words
                            })
                            .filter(n => n !== null)
                            .reverse()
                            .slice(0, 3)
                            .reverse();
                        break;
                    }
                }
                
                if (d4 === 0 || numbers.length !== 3) {
                    this.logStatus(`Initial passcode not recognized: Digits=${numbers.length}, D4=${d4}. Continuing listening.`, false);
                    return; 
                }
                
                const [d1, d2, d3] = numbers;
                
                if (typeof LARGE_DICTIONARY === 'undefined') { 
                    this.logStatus("Dictionary not loaded. (FATAL)", true); 
                    return; 
                }

                const matches = this.filterDictionary(d1, d2, d3, d4, LARGE_DICTIONARY);
                this.HISTORY = []; 
                this.HISTORY.push(matches);
                this.MATCHES = matches;

                this.logStatus(`Code: ${d1}${d2}${d3}${d4}. Matches: ${matches.length}`);
                
                this.checkMatchesAndProceed();
            },
            
            handleLetterInput(transcript) {
                if (this.MATCHES.length <= 1 || this.CURRENT_POSITION_INDEX === 0) {
                    return;
                }
                
                const trigger = "INTERESTING";
                const triggerIndex = transcript.indexOf(trigger);
                
                if (triggerIndex === -1) {
                    this.logStatus("No 'interesting' trigger. Continuing listening.", false);
                    return;
                }
                
                const preTrigger = transcript.substring(0, triggerIndex).trim();
                const preWords = preTrigger.split(' ').filter(w => w.length > 0);
                
                if (preWords.length === 0) {
                    this.logStatus("No word found before 'interesting'. Continuing listening.", false);
                    return;
                }
                
                const spokenWord = preWords[preWords.length - 1];
                const magicLetter = spokenWord[0].toUpperCase();
                const pos = this.CURRENT_POSITION_INDEX - 1; // 0-based index

                // MATCHES are already guaranteed to be uppercase from the filterDictionary step
                const filtered = this.MATCHES.filter(word => 
                    word.length > pos && word[pos] === magicLetter
                );

                if (filtered.length === 0) {
                    this.logStatus(`Filter failed: Letter '${magicLetter}' at position ${this.CURRENT_POSITION_INDEX} yielded 0 matches. Reverting to previous list.`, true);
                    return;
                }

                this.HISTORY.push(filtered);
                this.MATCHES = filtered;
                this.logStatus(`Filtered by letter '${magicLetter}' at position ${this.CURRENT_POSITION_INDEX}. ${filtered.length} matches remain.`);

                this.checkMatchesAndProceed();
            },

            // --- State and UI Update ---
            updateNotification(status) {
                const notifIcon = document.getElementById('notif-icon');
                const notifText = document.getElementById('notif-text');

                if (status === 'FINAL') {
                    const finalWord = this.MATCHES[0];
                    notifIcon.innerHTML = this.ICON_CHAT_SVG; 
                    notifText.innerHTML = `Sohan wants <span class="final-word-placeholder">${finalWord}</span> to...`;
                } else if (status === 'WORD_LIST' && this.MATCHES.length > 0) {
                    // Display the words, converting them back to lowercase for the discreet "shopping list" look
                    const displayWords = this.MATCHES.slice(0, 4).map(w => w.toLowerCase()).join(', ');
                    const moreText = this.MATCHES.length > 4 ? ` (+${this.MATCHES.length - 4})` : '';
                    
                    notifIcon.innerHTML = this.ICON_CHAT_SVG; 
                    notifText.innerHTML = `To buy ${displayWords}${moreText}`;
                } else {
                    // Initial or Error State
                    notifIcon.innerHTML = this.ICON_GEAR_SVG;
                    notifText.textContent = "System Update Available";
                }
            },

            checkMatchesAndProceed() {
                
                if (this.MATCHES.length === 1) {
                    // --- Final State ---
                    this.stopListening();
                    this.CURRENT_POSITION_INDEX = 0; 
                    this.updateNotification('FINAL');
                    // Reset Spotify widget to 0:00 after reveal
                    document.getElementById('current-second').textContent = '00';
                    this.logStatus(`FINAL WORD FOUND: ${this.MATCHES[0]}`);
                    
                } else if (this.MATCHES.length > 1) {
                    // --- Disambiguation State ---
                    const bestIndex = this.getDisambiguationIndex(this.MATCHES);

                    if (bestIndex === -1) {
                        this.logStatus(`Ambiguous State: ${this.MATCHES.length} matches. Cannot proceed. Magician must force word.`, true);
                        this.stopListening(); 
                        this.CURRENT_POSITION_INDEX = 0;
                        this.updateNotification('WORD_LIST');
                        return;
                    }
                    
                    this.CURRENT_POSITION_INDEX = bestIndex;
                    
                    // Update Music Player (0:XX)
                    document.getElementById('current-second').textContent = bestIndex.toString().padStart(2, '0');
                    
                    this.updateNotification('WORD_LIST');
                    
                } else {
                    // --- No Matches / Error State ---
                    this.resetApp();
                }
            },
            
            resetApp() {
                this.stopListening();
                this.MATCHES = [];
                this.HISTORY = [];
                this.CURRENT_POSITION_INDEX = 0;
                this.updateNotification('INITIAL');
                document.getElementById('current-second').textContent = '00';
                this.APP_STATE = 'AOD_LOCK';
                this.logStatus("App reset to AOD_LOCK state.");
            },
            
            // --- PWA Service Worker Registration ---
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js')
                            .then(reg => console.log('Service Worker registered.', reg.scope))
                            .catch(err => console.error('Service Worker registration failed:', err));
                    });
                }
            },

            // --- Initialization ---
            init() {
                // Check dictionary status 
                if (typeof LARGE_DICTIONARY === 'undefined' || LARGE_DICTIONARY.length === 0) {
                    this.logStatus("FATAL: Dictionary not accessible or is empty. Functionality limited.", true);
                    document.getElementById('notif-text').textContent = "ERROR: DICT NOT AVAILABLE";
                } else {
                    this.logStatus(`App ready. Dictionary size: ${LARGE_DICTIONARY.length}. Double-tap time to start.`);
                }
                
                this.initVoiceRecognition();
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);   
                
                // Attach double-tap listener to the time display element
                const timeElement = document.getElementById('aod-time');
                timeElement.addEventListener('click', (e) => this.handleDoubleTap(e));
                timeElement.addEventListener('touchstart', (e) => this.handleDoubleTap(e));
                
                // Set initial icon appearance
                document.getElementById('notif-icon').innerHTML = this.ICON_GEAR_SVG;
                
                // Register PWA Service Worker
                this.registerServiceWorker();
            }
        };

        window.onload = () => APP.init();
    </script>
</body>
</html>

